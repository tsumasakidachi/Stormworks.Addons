kana = {
    ["a"] = "あ",
    ["i"] = "い",
    ["u"] = "う",
    ["e"] = "え",
    ["o"] = "お",
    ["ka"] = "か",
    ["ki"] = "き",
    ["ku"] = "く",
    ["ke"] = "け",
    ["ko"] = "こ",
    ["kya"] = "きゃ",
    ["kyi"] = "きぃ",
    ["Kyu"] = "きゅ",
    ["kye"] = "きぇ",
    ["kyo"] = "きょ",
    ["ca"] = "か",
    ["ci"] = "し",
    ["cu"] = "く",
    ["ce"] = "せ",
    ["co"] = "こ",
    ["cya"] = "ちゃ",
    ["cyi"] = "ちぃ",
    ["cyu"] = "ちゅ",
    ["cye"] = "ちぇ",
    ["cyo"] = "ちょ",
    ["sa"] = "さ",
    ["si"] = "し",
    ["su"] = "す",
    ["se"] = "せ",
    ["so"] = "そ",
    ["sya"] = "しゃ",
    ["syi"] = "しぃ",
    ["syu"] = "しゅ",
    ["sye"] = "しぇ",
    ["syo"] = "しょ",
    ["sha"] = "しゃ",
    ["shi"] = "し",
    ["shu"] = "しゅ",
    ["she"] = "しぇ",
    ["sho"] = "しょ",
    ["ta"] = "た",
    ["ti"] = "ち",
    ["tu"] = "つ",
    ["te"] = "て",
    ["to"] = "と",
    ["tya"] = "ちゃ",
    ["tyi"] = "ちぃ",
    ["tyu"] = "ちゅ",
    ["tye"] = "ちぇ",
    ["tyo"] = "ちょ",
    ["tsu"] = "つ",
    ["cha"] = "ちゃ",
    ["chi"] = "ち",
    ["chu"] = "ちゅ",
    ["che"] = "ちぇ",
    ["cho"] = "ちょ",
    ["na"] = "な",
    ["ni"] = "に",
    ["nu"] = "ぬ",
    ["ne"] = "ね",
    ["no"] = "の",
    ["nya"] = "にゃ",
    ["nyi"] = "にぃ",
    ["nyu"] = "にゅ",
    ["nye"] = "にぇ",
    ["nyo"] = "にょ",
    ["ha"] = "は",
    ["hi"] = "ひ",
    ["hu"] = "ふ",
    ["he"] = "へ",
    ["ho"] = "ほ",
    ["hya"] = "ひゃ",
    ["hyi"] = "ひぃ",
    ["hyu"] = "ひゅ",
    ["hye"] = "ひぇ",
    ["hyo"] = "ひょ",
    ["fa"] = "ふぁ",
    ["fi"] = "ふぃ",
    ["fu"] = "ふゅ",
    ["fe"] = "ふぇ",
    ["fo"] = "ふぉ",
    ["ma"] = "ま",
    ["mi"] = "み",
    ["mu"] = "む",
    ["me"] = "め",
    ["mo"] = "も",
    ["mya"] = "みゃ",
    ["myi"] = "みぃ",
    ["myu"] = "みゅ",
    ["mye"] = "みぇ",
    ["myo"] = "みょ",
    ["ya"] = "や",
    ["yu"] = "ゆ",
    ["yo"] = "よ",
    ["ra"] = "ら",
    ["ri"] = "り",
    ["ru"] = "る",
    ["re"] = "れ",
    ["ro"] = "ろ",
    ["rya"] = "りゃ",
    ["ryi"] = "りぃ",
    ["ryu"] = "りゅ",
    ["rye"] = "りぇ",
    ["ryo"] = "りょ",
    ["wa"] = "わ",
    ["wo"] = "を",
    ["woo"] = "うぉ",
    ["va"] = "ヴぁ",
    ["vi"] = "ヴぃ",
    ["vu"] = "ヴ",
    ["ve"] = "ヴぇ",
    ["vo"] = "ヴぉ",
    ["ga"] = "が",
    ["gi"] = "ぎ",
    ["gu"] = "ぐ",
    ["ge"] = "げ",
    ["go"] = "ご",
    ["gya"] = "ぎゃ",
    ["gyi"] = "ぎぃ",
    ["gyu"] = "ぎゅ",
    ["gye"] = "ぎぇ",
    ["gyo"] = "ぎょ",
    ["za"] = "ざ",
    ["zi"] = "じ",
    ["zu"] = "ず",
    ["ze"] = "ぜ",
    ["zo"] = "ぞ",
    ["zya"] = "じゃ",
    ["zyi"] = "じぃ",
    ["zyu"] = "じゅ",
    ["zye"] = "じぇ",
    ["zyo"] = "じょ",
    ["ja"] = "じゃ",
    ["ji"] = "じ",
    ["ju"] = "じゅ",
    ["je"] = "じぇ",
    ["jo"] = "じょ",
    ["da"] = "だ",
    ["di"] = "ぢ",
    ["du"] = "づ",
    ["de"] = "で",
    ["do"] = "ど",
    ["dya"] = "ぢゃ",
    ["dyi"] = "ぢぃ",
    ["dyu"] = "ぢゅ",
    ["dye"] = "ぢぇ",
    ["dyo"] = "ぢょ",
    ["ba"] = "ば",
    ["bi"] = "び",
    ["bu"] = "ぶ",
    ["be"] = "べ",
    ["bo"] = "ぼ",
    ["bya"] = "びゃ",
    ["byi"] = "びぃ",
    ["byu"] = "びゅ",
    ["bye"] = "びぇ",
    ["byo"] = "びょ",
    ["pa"] = "ぱ",
    ["pi"] = "ぴ",
    ["pu"] = "ぷ",
    ["pe"] = "ぺ",
    ["po"] = "ぽ",
    ["pya"] = "ぴゃ",
    ["pyi"] = "ぴぃ",
    ["pyu"] = "ぴゅ",
    ["pye"] = "ぴぇ",
    ["pyo"] = "ぴょ",
    ["la"] = "ぁ",
    ["li"] = "ぃ",
    ["lu"] = "ぅ",
    ["le"] = "ぇ",
    ["lo"] = "ぉ",
    ["ltu"] = "っ",
    ["lya"] = "ゃ",
    ["lyu"] = "ゅ",
    ["lyo"] = "ょ",
    ["lwa"] = "ゎ",
    ["xa"] = "ぁ",
    ["xi"] = "ぃ",
    ["xu"] = "ぅ",
    ["xe"] = "ぇ",
    ["xo"] = "ぉ",
    ["xtu"] = "っ",
    ["xya"] = "ゃ",
    ["xyu"] = "ゅ",
    ["xyo"] = "ょ",
    ["xwa"] = "ゎ",
    ["kwa"] = "くゎ",
    ["gwa"] = "ぐゎ",
    ["-"] = "ー"
}

function onChatMessage(peer_id, sender_name, message)
    if peer_id < 0 then
        return
    end

    local message = string.lower(message)
    local message_kana = ""
    local len = string.len(message)

    if len > 200 then
        return
    end

    local index = 1
    local shift = 0

    while index + shift <= len do
        local sub = string.sub(message, index, index + shift)
        local matched = false

        for k, v in pairs(kana) do
            matched = k == sub

            if matched then
                break
            end
        end

        if matched then
            message_kana = message_kana .. kana[sub]
            index = index + shift + 1
            shift = 0
        elseif shift >= 2 or index + shift >= len then
            local letter1 = string.sub(message, index, index)
            local letter2 = string.sub(message, index + 1, index + 1)

            if index > 1 and string.find(letter1, "n", 1, true) and letter1 == letter2 then
                message_kana = message_kana .. "ん"
                index = index + 2
                shift = 0
            elseif string.find(letter1, "[kcsthfmyrwvgzjdbp]") and letter1 == letter2 then
                message_kana = message_kana .. "っ"
                index = index + 1
                shift = 0
            else
                message_kana = message_kana .. letter1
                index = index + 1
                shift = 0
            end
        else
            shift = shift + 1
        end
    end

    message_kana = string.gsub(message_kana, "([ぁ-ん])([n])", "%1ん")

    if message_kana ~= message then
        server.announce("", message_kana, -1)
    end
end
